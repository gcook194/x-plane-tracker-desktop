<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Leaflet Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          width: 100%;
        }

        #map {
          height: 100%;
          width: 100%;
        }

        .white-dot-icon {
          background-color: white;
          border-radius: 50%;
          width: 8px;
          height: 8px;
          border: 1px solid rgba(255,255,255,0.6);
        }

        #map {
            background-color: #252525;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
<script>
    var markers = [];
    var map;

    var whiteDotIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" width="8" height="8">
          <circle cx="4" cy="4" r="3" fill="white" />
        </svg>
      `),
      iconSize: [9, 9],
      iconAnchor: [4, 4],
      popupAnchor: [0, -4]
    });

    function loadMap() {
        if (map != null) {
            markers = [];
            map.off();
            map.remove();
        }

        map = L.map('map').fitWorld();
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
          maxZoom: 19
        }).addTo(map);
    }

    function addMarkerToMap(lat, lng, label) {
        const marker = L.marker([lat, lng], { icon: whiteDotIcon }).addTo(map).bindPopup(label);
        markers.push(marker);
    }

    function drawBasicRouteLine() {
        if (markers.length > 1) {
            for (var i = 0; i < markers.length; i++) {
                if (markers[i+1] != null) {
                    const startLine = markers[i].getLatLng();
                    const endLine = markers[i+1].getLatLng();

                    L.polyline([startLine, endLine], {
                        color: 'white',
                        opacity: 0.8,
                        weight: 1,
                        dashArray: '4, 6'
                    }).addTo(map);
                }
            }
        }
    }

    function addRotatedPlaneMarker(latLong, heading) {
        const adjustedHeading = heading - 90;

        const iconHtml = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 1200 1200"
                 style="transform: rotate(${adjustedHeading}deg); transform-origin: center;">
                <path d="M321,1164h120l269.28-480.06H1020c0,0,180,0,180-83.94c0-84-180-84-180-84H710.28L441,36H321l149.28,480H255.06L120,395.94H0l96.06,204L0,804h120l135.06-120.06h215.22L321,1164z"
                      fill="#3498db"/>
            </svg>
        `;

        const planeIcon = L.divIcon({
            className: '',
            html: iconHtml,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
        });

        L.marker(latLong, { icon: planeIcon }).addTo(map);
    }

    function drawActualRouteLine(latLongs, heading) {
        const flightPath = L.polyline(latLongs, {
            weight: 2,
            opacity: 0.8,
            smoothFactor: 1
        }).addTo(map);

        const lastCoord = latLongs[latLongs.length - 1];
        addRotatedPlaneMarker(lastCoord, heading);

        map.fitBounds(flightPath.getBounds());
    }

    function fitToAllMarkers() {
        if (markers.length > 0) {
            var group = L.featureGroup(markers);
            map.fitBounds(group.getBounds());
        }
    }
</script>
</body>
</html>
